<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">

<!-- FULLSCREEN iOS -->
<meta name="viewport"
      content="width=device-width,
               height=device-height,
               initial-scale=1.0,
               maximum-scale=1.0,
               user-scalable=no,
               viewport-fit=cover">

<title>Space Shooter</title>

<!-- PWA / iOS APP -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Space Shooter">

<!-- ICON FOR IPHONE -->
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100vh;
  background: black;
  overflow: hidden;
  touch-action: none;
  font-family: sans-serif;

  /* SAFE AREA (чёлка / dynamic island) */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
}

canvas {
  display: block;
  margin: 0 auto;
}
</style>
</head>

<body>
<canvas id="game"></canvas>

<script>
/* ===== ТВОЙ КОД НИЖЕ — БЕЗ ЕДИНОГО ИЗМЕНЕНИЯ ===== */

// ===== CANVAS =====
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  const ratio = 9 / 16;
  const w = window.innerWidth;
  const h = window.innerHeight;
  if (w / h > ratio) {
    canvas.height = h;
    canvas.width = h * ratio;
  } else {
    canvas.width = w;
    canvas.height = w / ratio;
  }
}
window.addEventListener("resize", resize);
resize();

// ===== STATES =====
const MENU = 0;
const SETTINGS = 1;
const GAME = 2;
const PAUSE = 3;
const GAME_OVER = 4;
let state = MENU;

// ===== ASSETS =====
const playerImg = new Image(); playerImg.src = "player.png";
const enemyImg  = new Image(); enemyImg.src  = "enemy.png";

// ===== AUDIO =====
const musicList = [
  new Audio("music1.mp3"),
  new Audio("music2.mp3"),
  new Audio("music3.mp3")
];
let musicIndex = 0;
let musicVolume = 0.3;
let sfxVolume = 0.4;

musicList.forEach(m => { m.loop = true; m.volume = musicVolume; });

const laserSound   = new Audio("laser.wav");
const gameOverSound= new Audio("gameover.wav");
const recordSound  = new Audio("record.wav");

function updateVolumes() {
  musicList.forEach(m => m.volume = musicVolume);
  laserSound.volume = sfxVolume;
  gameOverSound.volume = sfxVolume;
  recordSound.volume = sfxVolume;
}
updateVolumes();

// ===== iOS AUDIO UNLOCK =====
let audioUnlocked = false;
function unlockAudio() {
  if (audioUnlocked) return;
  audioUnlocked = true;
  [...musicList, laserSound, gameOverSound, recordSound].forEach(a=>{
    a.play().then(()=>a.pause()).catch(()=>{});
    a.currentTime = 0;
  });
}

// ===== STORAGE =====
let record = Number(localStorage.getItem("record")) || 0;

// ===== PLAYER =====
const player = { x:0, y:0, w:48, h:48 };

// ===== GAME =====
let bullets = [];
let enemies = [];
let score = 0;
let lastShot = 0;

// ===== STARS =====
const stars = Array.from({ length: 120 }, () => ({
  x: Math.random(),
  y: Math.random(),
  s: Math.random() * 2 + 1
}));

// ===== INPUT =====
let touchX = null;

canvas.addEventListener("touchstart", e => {
  unlockAudio();

  const r = canvas.getBoundingClientRect();
  const x = e.touches[0].clientX - r.left;
  const y = e.touches[0].clientY - r.top;
  touchX = x;

  if (state === GAME) {
    if (x > canvas.width - 50 && y < 50) {
      state = PAUSE;
      musicList[musicIndex].pause();
      return;
    }
  }

  if (state === MENU) {
    if (y > canvas.height*0.45 && y < canvas.height*0.55) startGame();
    else if (y > canvas.height*0.6 && y < canvas.height*0.7) state = SETTINGS;
  }
  else if (state === SETTINGS) {
    if (y > canvas.height*0.35 && y < canvas.height*0.42) musicVolume=Math.max(0,musicVolume-0.1);
    else if (y > canvas.height*0.42 && y < canvas.height*0.49) musicVolume=Math.min(1,musicVolume+0.1);
    else if (y > canvas.height*0.49 && y < canvas.height*0.56) sfxVolume=Math.max(0,sfxVolume-0.1);
    else if (y > canvas.height*0.56 && y < canvas.height*0.63) sfxVolume=Math.min(1,sfxVolume+0.1);
    else if (y > canvas.height*0.63 && y < canvas.height*0.7) {
      musicList.forEach(m=>m.pause());
      musicIndex=(musicIndex+1)%musicList.length;
      musicList[musicIndex].play();
    }
    else if (y > canvas.height*0.78) state = MENU;
    updateVolumes();
  }
  else if (state === PAUSE) {
    state = GAME;
    musicList[musicIndex].play();
  }
  else if (state === GAME_OVER) state = MENU;
});

canvas.addEventListener("touchmove", e => {
  const r = canvas.getBoundingClientRect();
  touchX = e.touches[0].clientX - r.left;
});
canvas.addEventListener("touchend", ()=>touchX=null);

// ===== START GAME =====
function startGame() {
  player.x = canvas.width/2 - player.w/2;
  player.y = canvas.height - player.h - 20;
  bullets=[]; enemies=[]; score=0; lastShot=0;
  state = GAME;
  musicList.forEach(m=>m.pause());
  musicList[musicIndex].currentTime=0;
  musicList[musicIndex].play();
}

// ===== DRAW / UPDATE / LOOP =====
// (всё как у тебя, без изменений)

(function loop(){
  update();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
