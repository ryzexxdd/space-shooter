<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Space Shooter</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  overflow: hidden;
  touch-action: none;
  user-select: none;
  -webkit-user-select: none;
}
canvas {
  display: block;
  margin: 0 auto;
}
</style>
</head>

<body>
<canvas id="game"></canvas>

<script>
// ================= CANVAS =================
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  const ratio = 9 / 16;
  const w = window.innerWidth;
  const h = window.innerHeight;
  if (w / h > ratio) {
    canvas.height = h;
    canvas.width = h * ratio;
  } else {
    canvas.width = w;
    canvas.height = w / ratio;
  }
}
window.addEventListener("resize", resize);
resize();

// ================= STATES =================
const MENU = 0;
const GAME = 1;
let state = MENU;

// ================= ASSETS =================
const playerImg = new Image();
playerImg.src = "player.png";

const enemyImg = new Image();
enemyImg.src = "enemy.png";

const laserSound = new Audio("laser.wav");
const gameOverSound = new Audio("gameover.wav");
const music = new Audio("music1.mp3");
music.loop = true;
music.volume = 0.3;

// ================= STORAGE =================
let record = Number(localStorage.getItem("record")) || 0;

// ================= PLAYER =================
const player = {
  x: 0,
  y: 0,
  w: 48,
  h: 48
};

// ================= GAME =================
let bullets = [];
let enemies = [];
let score = 0;
let lastShot = 0;

// ================= STARS =================
const stars = Array.from({ length: 120 }, () => ({
  x: Math.random(),
  y: Math.random(),
  s: Math.random() * 2 + 1
}));

// ================= INPUT =================
let touchX = null;
let moveDir = 0;

canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  touchX = e.touches[0].clientX;
  if (state === MENU) startGame();
});

canvas.addEventListener("touchmove", e => {
  e.preventDefault();
  touchX = e.touches[0].clientX;
});

canvas.addEventListener("touchend", () => touchX = null);

window.addEventListener("keydown", e => {
  if (e.key === "r" || e.key === "R") {
    if (state === MENU) startGame();
  }
  if (e.key === "ArrowLeft" || e.key === "a") moveDir = -1;
  if (e.key === "ArrowRight" || e.key === "d") moveDir = 1;
});

window.addEventListener("keyup", () => moveDir = 0);

// ================= START GAME =================
function startGame() {
  player.x = canvas.width / 2 - player.w / 2;
  player.y = canvas.height - player.h - 20;
  bullets = [];
  enemies = [];
  score = 0;
  lastShot = 0;
  state = GAME;

  music.currentTime = 0;
  music.play();
}

// ================= DRAW =================
function drawStars() {
  ctx.fillStyle = "white";
  for (let s of stars) {
    s.y += s.s / 120;
    if (s.y > 1) s.y = 0;
    ctx.fillRect(s.x * canvas.width, s.y * canvas.height, s.s, s.s);
  }
}

function drawCenter(text, y, size) {
  ctx.fillStyle = "white";
  ctx.font = `${size}px sans-serif`;
  ctx.textAlign = "center";
  ctx.fillText(text, canvas.width / 2, y);
}

// ================= UPDATE =================
function update() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawStars();

  if (state === MENU) {
    drawCenter("SPACE SHOOTER", canvas.height / 2 - 40, 42);
    drawCenter("Press R or TAP to Start", canvas.height / 2 + 20, 18);
    drawCenter("Record: " + record, canvas.height / 2 + 50, 16);
    return;
  }

  // ===== MOVE =====
  if (touchX !== null) {
    player.x += (touchX - player.x - player.w / 2) * 0.15;
  } else {
    player.x += moveDir * 6;
  }
  player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));

  // ===== SHOOT =====
  if (Date.now() - lastShot > 350) {
    bullets.push({ x: player.x + player.w / 2 - 2, y: player.y });
    laserSound.currentTime = 0;
    laserSound.play();
    lastShot = Date.now();
  }

  bullets.forEach(b => b.y -= 8);
  bullets = bullets.filter(b => b.y > -20);

  // ===== ENEMIES =====
  if (Math.random() < 0.02) {
    enemies.push({ x: Math.random() * (canvas.width - 48), y: -60 });
  }

  enemies.forEach(e => e.y += 3);

  for (let e of enemies) {
    if (e.y > canvas.height) endGame();

    for (let b of bullets) {
      if (
        b.x > e.x &&
        b.x < e.x + 48 &&
        b.y > e.y &&
        b.y < e.y + 48
      ) {
        e.y = canvas.height + 200;
        b.y = -200;
        score++;
      }
    }
  }

  // ===== DRAW OBJECTS =====
  ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);

  ctx.fillStyle = "yellow";
  bullets.forEach(b => ctx.fillRect(b.x, b.y, 4, 10));

  enemies.forEach(e => ctx.drawImage(enemyImg, e.x, e.y, 48, 48));

  ctx.fillStyle = "white";
  ctx.font = "18px sans-serif";
  ctx.textAlign = "left";
  ctx.fillText("Score: " + score, 10, 24);
  ctx.fillText("Record: " + record, 10, 44);
}

// ================= END GAME =================
function endGame() {
  music.pause();
  gameOverSound.play();

  if (score > record) {
    record = score;
    localStorage.setItem("record", record);
  }

  state = MENU;
}

// ================= LOOP =================
function loop() {
  update();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
