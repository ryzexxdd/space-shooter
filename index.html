<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width,
               height=device-height,
               initial-scale=1.0,
               maximum-scale=1.0,
               user-scalable=no,
               viewport-fit=cover">

<title>Space Shooter</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Space Shooter">

<link rel="apple-touch-icon" sizes="180x180" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100vh;
  background: black;
  overflow: hidden;
  touch-action: none;
  font-family: sans-serif;
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
}

canvas {
  display: block;
  margin: 0 auto;
}
</style>
</head>

<body>
<canvas id="game"></canvas>

<script>
// ===== CANVAS =====
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ===== STATES =====
const MENU = 0;
const SETTINGS = 1;
const GAME = 2;
const PAUSE = 3;
const GAME_OVER = 4;
const SHOP = 5; // === SHOP ADD ===
let state = MENU;

// ===== ASSETS =====
let playerImg = new Image();
playerImg.src = "player.png";
const enemyImg  = new Image(); enemyImg.src  = "enemy.png";

// ===== AUDIO =====
const musicList = [
  new Audio("music1.mp3"),
  new Audio("music2.mp3"),
  new Audio("music3.mp3")
];
let musicIndex = 0;
let musicVolume = 0.3;
let sfxVolume = 0.4;

musicList.forEach(m => { m.loop = true; m.volume = musicVolume; });

const laserSound   = new Audio("laser.wav");
const gameOverSound= new Audio("gameover.wav");
const recordSound  = new Audio("record.wav");

// ===== STORAGE =====
let record = Number(localStorage.getItem("record")) || 0;

// === SHOP ADD ===
let coins = Number(localStorage.getItem("coins")) || 0;
let ownedSkins = JSON.parse(localStorage.getItem("ownedSkins")) || [];
let selectedSkin = Number(localStorage.getItem("selectedSkin")) || 0;

const skins = [
  { id:1, name:"Rare", price:100, color:"#4da6ff", img:"skin1.png" },
  { id:2, name:"Epic", price:200, color:"#b84dff", img:"skin2.png" },
  { id:3, name:"Mythical", price:300, color:"#ff4d4d", img:"skin3.png" },
  { id:4, name:"Legendary", price:500, color:"#ffd700", img:"skin4.png" },
  { id:5, name:"X", price:1000, color:"#ffffff", img:"skin5.png" }
];

// ===== PLAYER =====
const player = { x:0, y:0, w:48, h:48 };

// ===== GAME =====
let bullets = [];
let enemies = [];
let score = 0;
let lastShot = 0;

// ===== STARS =====
const stars = Array.from({ length: 300 }, () => ({
  x: Math.random(),
  y: Math.random(),
  s: Math.random() * 2 + 1
}));

// ===== INPUT =====
let touchX = null;

canvas.addEventListener("touchstart", e => {
  const r = canvas.getBoundingClientRect();
  const x = e.touches[0].clientX - r.left;
  const y = e.touches[0].clientY - r.top;
  touchX = x;

  if (state === MENU) {
    if (y > canvas.height*0.45 && y < canvas.height*0.55) startGame();
    else if (y > canvas.height*0.6 && y < canvas.height*0.7) state = SETTINGS;
    else if (y > canvas.height*0.75 && y < canvas.height*0.85) state = SHOP;
  }

  else if (state === SHOP) {
    skins.forEach((s,i)=>{
      const sy = 120 + i*90;
      if (y > sy && y < sy+70) {
        if (!ownedSkins.includes(s.id) && coins >= s.price) {
          coins -= s.price;
          ownedSkins.push(s.id);
          localStorage.setItem("coins", coins);
          localStorage.setItem("ownedSkins", JSON.stringify(ownedSkins));
        } else if (ownedSkins.includes(s.id)) {
          selectedSkin = s.id;
          localStorage.setItem("selectedSkin", selectedSkin);
          playerImg.src = s.img;
        }
      }
    });
    if (y > canvas.height*0.9) state = MENU;
  }

  else if (state === GAME_OVER) state = MENU;
});

// ===== START GAME =====
function startGame() {
  player.x = canvas.width/2 - player.w/2;
  player.y = canvas.height - player.h - 20;
  bullets=[]; enemies=[]; score=0; lastShot=0;
  state = GAME;
}

// ===== DRAW =====
function drawStars() {
  ctx.fillStyle="white";
  for (let s of stars) {
    s.y += s.s / 600;
    if (s.y > 1) s.y = 0;
    ctx.fillRect(s.x*canvas.width, s.y*canvas.height, s.s, s.s);
  }
}

function center(t,y,s=24){
  ctx.fillStyle="white";
  ctx.font=`${s}px sans-serif`;
  ctx.textAlign="center";
  ctx.fillText(t,canvas.width/2,y);
}

// ===== UPDATE =====
function update() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawStars();

  if (state === MENU) {
    center("SPACE SHOOTER",canvas.height*0.35,40);
    center("START",canvas.height*0.5);
    center("SETTINGS",canvas.height*0.6);
    center("SHOP",canvas.height*0.7);
    center("COINS: "+coins,canvas.height*0.85,18);
    return;
  }

  if (state === SHOP) {
    center("SHOP",50,36);
    center("COINS: "+coins,80,18);

    skins.forEach((s,i)=>{
      const y = 120 + i*90;
      ctx.strokeStyle = s.color;
      ctx.strokeRect(40,y,canvas.width-80,70);
      ctx.fillStyle = s.color;
      ctx.fillText(`${s.name} - ${s.price}`,canvas.width/2,y+40);
    });

    center("BACK",canvas.height-20,18);
    return;
  }

  if (state === GAME) {
    if (Date.now()-lastShot>650) {
      bullets.push({x:player.x+player.w/2-2,y:player.y});
      lastShot=Date.now();
    }

    bullets.forEach(b=>b.y-=8);

    enemies.forEach(e=>e.y+=3);

    for (let i=enemies.length-1;i>=0;i--){
      const e=enemies[i];
      for (let j=bullets.length-1;j>=0;j--){
        const b=bullets[j];
        if (b.x>e.x&&b.x<e.x+48&&b.y>e.y&&b.y<e.y+48){
          enemies.splice(i,1);
          bullets.splice(j,1);
          score++;
          coins++; // === SHOP ADD ===
          localStorage.setItem("coins",coins);
          break;
        }
      }
    }

    ctx.drawImage(playerImg,player.x,player.y,48,48);
    bullets.forEach(b=>ctx.fillRect(b.x,b.y,4,10));
    enemies.forEach(e=>ctx.drawImage(enemyImg,e.x,e.y,48,48));

    ctx.textAlign="left";
    ctx.fillText("Score: "+score,12,22);
    ctx.fillText("Coins: "+coins,12,40);
  }
}

// ===== LOOP =====
(function loop(){
  update();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
